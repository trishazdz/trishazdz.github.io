<!doctype html>
<html>
<head>
	<script src="http://d3js.org/d3.v3.min.js"  charset="utf-8"></script>
	<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js'></script>
</head>
<body>
	<style>
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}

		.data-point {
			fill: #f79973;
		}


	</style>
	
	<form data-bind="submit: fetchSession">
		<input data-bind="textInput: sessionId" placeholder="Participant ID" />
		<button type="submit">Find Data</button>
	</form>
	<p>
		<span data-bind="text: errorId"></span><span data-bind="text: error"></span>
	</p>
	<p data-bind="text: activeId"></p>

	<script>
		var data, stimuli;

		var w = 500, h = 500, padding = 20;

		var yScale = d3.scale.linear()
		    		.domain([0,14])
		    		.range([padding * 2, h - padding]);

		var Viewmodel = {
			sessionId: ko.observable(),
			session: ko.observable(),
			activeId: ko.observable(),

			error: ko.observable(undefined),
			errorId: ko.observable(undefined),

			canvas: undefined,

			initSvg: function() {
				var xScale = d3.scale.linear()
					.domain([0, 1000])
					.range([0, w]);

				var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("top")
					.ticks(5);

				this.canvas = d3.select("body")
		        	.append("svg")
		        	.attr("id", "dv")
		        	.attr("width", w)
		        	.attr("height", h);

				this.canvas.append("g")
			        	.attr("class", "axis")
			        	.attr("id", "x-axis")
			        	.attr("transform", "translate(10, 20)")	
			        	.call(xAxis);
			},

			fetchSession: function() {
				var id = this.sessionId();
				var dataElement = this.getDataElementById(id);

				if (dataElement) {
					this.error("");
					this.errorId("");
					this.activeId(id);
					this.session(new Session( dataElement ));
					this.plotSession();
				} else {
					this.activeId("");
					this.errorId(id);
					this.error(" doesn't exist. Please double check that you have entered the correct ID.");
				}

			},

			getDataElementById: function(id) {
				var element = data[id];

				if (element) { return element; } 
				else { return false; }
			},

			getStimuli: function(seed, type) {
				var key = seed + type;

				var values = {
					"0t": stimuli["1"],
					"1t": stimuli["2"],
					"2t": stimuli["3"],
					"3t": stimuli["4"],
					"0m": stimuli["5"],
					"1m": stimuli["6"],
					"2m": stimuli["7"],
					"3m": stimuli["8"]
				};

				return values[key];
			},

			plotSession: function() {
				var session = this.session();
				var sessionStimuli = this.getStimuli(session.Seed, session.Type);

				var xScale = d3.scale.linear()
		        	.domain([d3.min(sessionStimuli.SeedStimuli, function(d) { return d; }) - 500, 500 + d3.max(sessionStimuli.SeedStimuli, function(d) {return d;})])
		        	.range([padding, w - padding * 2]);

				var circle = this.canvas.selectAll("circle")
		        	.data(session.Tapping);

		        circle
					.enter()
		        	.append("circle")
		        	.attr("r", function(d) {
		        		return 7;
		        	})
		        	.attr("class", "data-point");

		        circle
		        	.attr("cx", function(d) {
		        		return xScale(d);
		       		})
		        	.attr("cy", function(d, i) {
		        		return yScale(i);
		        	});

		        circle
		        	.exit()
		        		.remove();

		         var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("top")
					.ticks(5);
					
		        this.canvas.select("#x-axis")
		        	.call(xAxis);

			}
		};
		

		function Session(params) {
			for (key in params) {
				this[key] = params[key];
			}
		}

		Session.prototype.getAverage = function() {
			var sum = 0;

			for (var i = 0; i < this.taps.length; i++) {
				sum += Number(this.taps[i]);
			}

			return sum / this.taps.length;
		}

	    
		d3.json('2015-10-03.json', function(json) {
			data = json;

			d3.json('stimuli.json', function(json) {
				stimuli = json;

				ko.applyBindings(Viewmodel);
				Viewmodel.initSvg();
			});
		});
	</script>
</body>
</html>