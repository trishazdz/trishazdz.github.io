<!doctype html>
<html>
<head>
	<script src="http://d3js.org/d3.v3.min.js"  charset="utf-8"></script>
	<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js'></script>
</head>
<body>
	<style>
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}

		.data-point {
			fill: black;
		}

		.source-point {
			fill: none;
		}

		.seed-line {
			stroke: black;
			stroke-width: 2;
		}

		.error-margin {
			stroke-width: 13;
		}

		.faster {
			stroke: red;
		}

		.slower {
			stroke: yellow;
		}
		.warning {color:red;}


	</style>
	
	<form data-bind="submit: fetchSession">
		<input data-bind="textInput: sessionId" placeholder="Participant ID" />
		<button type="submit">Find Data</button>
	</form>
	<p class="warning">
		<span data-bind="text: errorId"></span><span data-bind="text: error"></span>
	</p>
	<p data-bind="text: activeId"></p>

	<div data-bind="if: session">
		<p>You heard 
			<a href="" data-bind="click: fetchSource" >
				<span data-bind="text: session().SourceID"></span>
			</a>'s version
		</p>
	</div>

	<script>
		var data, stimuli;

		var w = 500, h = 500, padding = 20;

		var yScale = d3.scale.linear()
		    		.domain([0,14])
		    		.range([padding * 2, h - padding]);

		var Viewmodel = {
			sessionId: ko.observable(1306),
			session: ko.observable(undefined),
			activeId: ko.observable(),

			error: ko.observable(undefined),
			errorId: ko.observable(undefined),

			canvas: undefined,

			initSvg: function() {
				var xScale = d3.scale.linear()
					.domain([0, 1000])
					.range([0, w]);

				var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("top")
					.ticks(5);

				this.canvas = d3.select("body")
		        	.append("svg")
		        	.attr("id", "dv")
		        	.attr("width", w)
		        	.attr("height", h);

				this.canvas.append("g")
			        	.attr("class", "axis")
			        	.attr("id", "x-axis")
			        	.attr("transform", "translate(10, 20)")	
			        	.call(xAxis);

			    this.fetchSession();
			},

			fetchSource: function() {
				var sourceId = this.session().SourceID;
				this.sessionId(sourceId);
				this.fetchSession();
			},

			fetchSession: function() {
				var id = this.sessionId();
				var dataElement = this.getDataElementById(id);

				if (dataElement) {
					this.error("");
					this.errorId("");
					this.activeId(id);
					this.session(new Session( dataElement ));
					this.plotSession();
					this.fetchChain(this.session().ChainID);
				} else {
					this.activeId("");
					this.errorId(id);
					this.error(" doesn't exist. Please double check that you have entered the correct ID.");
				}

			},

			fetchChain: function(chainId) {
				var chain = [];
				for (var key in data) {
					if (data[key].ChainID == chainId) {
						chain.push(key);
					}
				};

				return chain;
			},

			getDataElementById: function(id) {
				if (id >= 1000) {
					var element = data[id];

					if (element) { return element; } 
					else { return false; }
				} else {
					// fetch seed stimuli

					this.getStimuli()
				}
				
			},

			getStimuli: function(seed, type) {
				var key = seed + type;

				var values = {
					"0t": stimuli["1"],
					"1t": stimuli["2"],
					"2t": stimuli["3"],
					"3t": stimuli["4"],
					"0m": stimuli["5"],
					"1m": stimuli["6"],
					"2m": stimuli["7"],
					"3m": stimuli["8"]
				};

				return values[key];
			},

			plotSession: function() {
				var session = this.session();
				var sessionStimuli = this.getStimuli(session.Seed, session.Type);

				if (session.SourceID >= 1000) {
					var sessionSource = new Session( this.getDataElementById(session.SourceID) );
				} else {
					var sessionSource = {Tapping: sessionStimuli.SeedStimuli};
				}

				var xScale = d3.scale.linear()
		        	.domain([d3.min(sessionStimuli.SeedStimuli, function(d) { return d; }) - 500, 500 + d3.max(sessionStimuli.SeedStimuli, function(d) {return d;})])
		        	.range([padding, w - padding * 2]);

		        var bothData = [];

		        for ( var i = 0; i < sessionSource.Tapping.length; i++ ) {
		        	bothData.push( {source: sessionSource.Tapping[i], 
		        					session: session.Tapping[i] } );
		        };


		        var errorMargins = this.canvas.selectAll(".error-margin")
		        	.data(bothData);

		        errorMargins
		        		.attr("class", function(d) {
		        			if (d.session > d.source) {
		        				return "error-margin slower";
		        			} else {
		        				return "error-margin faster";
		        			}
		        		})
		        		.attr("x1", function(d) {
		        			return xScale(d.session);
		        		})
		        		.attr("y1", function(d, i) {
		        			return yScale(i);
		        		})
		        		.attr("x2", function(d) {
		        			return xScale(d.source);
		        		})
		        		.attr("y2", function(d, i) {
		        			return yScale(i);
		        		})
		        	.enter()
		        		.append("line")
		        		.attr("class", function(d) {
		        			if (d.session > d.source) {
		        				return "error-margin slower";
		        			} else {
		        				return "error-margin faster";
		        			}
		        		})
		        		.attr("x1", function(d) {
		        			return xScale(d.session);
		        		})
		        		.attr("y1", function(d, i) {
		        			return yScale(i);
		        		})
		        		.attr("x2", function(d) {
		        			return xScale(d.source);
		        		})
		        		.attr("y2", function(d, i) {
		        			return yScale(i);
		        		});

		        errorMargins
		        	.exit()
		        		.remove();

				var dataPoints = this.canvas.selectAll(".data-point")
					.data(session.Tapping);

				dataPoints
			        	.attr("cx", function(d) {
			        		return xScale(d);
			       		})
			        	.attr("cy", function(d, i) {
			        		return yScale(i);
			        	})
					.enter()
		        		.append("circle")
		        		.attr("r", function(d) {
		        			return 7;
		        		})
		        		.attr("cx", function(d) {
			        		return xScale(d);
			       		})
			        	.attr("cy", function(d, i) {
			        		return yScale(i);
			        	})
		        		.attr("class", "data-point");

		        dataPoints
		        	.exit()
		        		.remove();

		        var sourcePoints = this.canvas.selectAll(".source-point")
		        	.data(sessionSource.Tapping);
		        sourcePoints
		       			.attr("cx", function(d) {
		        			return xScale(d);
		        		})
		        		.attr("cy", function(d, i) {
		        			return yScale(i);
		        		})
		        	.enter()
		        		.append("circle")
		        		.attr("r", function(d) {
		        			return 7;
		        		})
		        		.attr("cx", function(d) {
		        			return xScale(d);
		        		})
		        		.attr("cy", function(d, i) {
		        			return yScale(i);
		        		})
		        		.attr("class", "source-point");

		        sourcePoints
		        	.exit()
		        		.remove();

		       	this.canvas.selectAll("line.seed-line")
		       		.remove();

		        var seedLine = this.canvas.selectAll("line.seed-line")
		        	.data(sessionStimuli.SeedStimuli);

		        seedLine
			        	.attr("x1", function(d) {
			        		return xScale(d);
			        	})
			        	.attr("y1", function(d, i) {
			        		return (yScale(i) - 7);
			        	})
			        	.attr("x2", function(d) {
			        		return xScale(d);
			        	})
			        	.attr("y2", function(d, i) {
			        		return (yScale(i) + 5);
			        	})
		        	.enter()
			        	.append("line")
			        	.attr("x1", function(d) {
			        		return xScale(d);
			        	})
			        	.attr("y1", function(d, i) {
			        		return (yScale(i) - 7);
			        	})
			        	.attr("x2", function(d) {
			        		return xScale(d);
			        	})
			        	.attr("y2", function(d, i) {
			        		return (yScale(i) + 5);
			        	})
			        	.attr("class", "seed-line");

		        seedLine
		        	.exit()
		        		.remove();
		        	

		       
		        var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("top")
					.ticks(5);
					
		        this.canvas.select("#x-axis")
		        	.call(xAxis);

			}
		};
		

		function Session(params) {
			for (key in params) {
				this[key] = params[key];
			}
		}

		Session.prototype.getAverage = function() {
			var sum = 0;

			for (var i = 0; i < this.taps.length; i++) {
				sum += Number(this.taps[i]);
			}

			return sum / this.taps.length;
		}

	    
		d3.json('2015-10-03.json', function(json) {
			data = json;

			d3.json('stimuli.json', function(json) {
				stimuli = json;

				ko.applyBindings(Viewmodel);
				Viewmodel.initSvg();
			});
		});
	</script>
</body>
</html>